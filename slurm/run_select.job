#!/bin/bash
#SBATCH --job-name=swimmer_confinement	 # Job name
#SBATCH --mail-type=BEGIN,END,FAIL       # Mail events (NONE, BEGIN, END, FAIL, ALL)
#SBATCH --mail-user=mjs572@york.ac.uk    # Where to send mail
#SBATCH --ntasks=2                      # Run a single task...
#SBATCH --cpus-per-task=1                # ...with four cores
#SBATCH --mem=2gb                       # Job memory request
#SBATCH --time=08:00:00                  # Time limit hrs:min:sec
#SBATCH --output=%x_J%j.log         # Standard output and error log
#SBATCH --account=math-fluidfilm-2020    # Project account

# --------------------------------------------------------------------------
# 				JOB USAGE
# -------------------------------------------------------------------------
# 		 		 WARNING
# Not designed as a standalone job! SBATCH cannot take environment variables,
# instead these variables should be *overwritten* using an appropriate bash
# script.
#
# INPUT (via --export=VAR=VAL)
# SCRIPTNAME 		- name of .inp file to be run (WITHOUT .inp EXTENSION)
#
# IMPORTANT OVERRIDES (via --ntasks=VAL, etc)
# --ntasks		- Number of tasks (read: cores desired)
# --time 		- Maximum expected time of of job
# --mem 		- Maximum expected memory of job
#
# -------------------------------------------------------------------------

BATCHDIR='/users/mjs572/scratch/ludwig/slurm' 

echo Running job on host:
echo -e '\t'`hostname` at `date`
echo 
echo N_TASKS: $SLURM_NTASKS
echo JOB_NAME: $SLURM_JOB_NAME 	
echo SCRIPTNAME: $SCRIPTNAME
echo --------------------------------------
echo
echo Current working directory: `pwd`

cwd=$(pwd)

echo Navigating to script directory...

cd $BATCHDIR
echo ...current dir: `pwd`
echo Navigating to Ludwig root...
cd ../
echo ...current dir: `pwd`
echo
echo --------------------------------------
echo
echo Loading SLURM OpenMPI Module  
	module load mpi/OpenMPI
echo Cleaning Ludwig
echo
echo --------------------------------------
echo
make clean
echo
echo --------------------------------------
echo
echo Copying config file
cp ./config/unix-mpicc-default.mk ./config.mk
echo
echo --------------------------------------
echo
echo Building Ludwig
echo
echo --------------------------------------
echo
make -j $SLURM_NTASKS
echo
echo --------------------------------------
echo
echo Copying Ludwig to working directory
cp ./src/Ludwig.exe $cwd
echo
echo --------------------------------------
echo
echo Returning to working directory
cd $cwd
echo Current dir: `pwd`
echo 
echo --------------------------------------
echo
echo Running $SCRIPTNAME
echo 
echo --------------------------------------
echo
./run.sh $SCRIPTNAME $SLURM_NTASKS
echo
echo --------------------------------------
echo
echo Running $SCRIPTNAME
echo
echo --------------------------------------
echo
./extractconditional.sh $SCRIPTNAME
echo
echo --------------------------------------
echo
./cleanraw.sh $SCRIPTNAME
echo
echo --------------------------------------
echo --------------------------------------
echo              FINISHED
echo --------------------------------------
echo --------------------------------------









